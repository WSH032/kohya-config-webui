# -*- coding: utf-8 -*-
"""kohya_config_webui.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/github/WSH032/kohya-config-webui/blob/main/kohya_config_webui.ipynb

| ![visitors](https://visitor-badge.glitch.me/badge?page_id=wsh.kohya_config_webui) | [![GitHub Repo stars](https://img.shields.io/github/stars/WSH032/kohya-config-webui?style=social)](https://github.com/WSH032/kohya-config-webui)</a> |

#A WebUI for making config files used by kohya_sd_script

Created by [WSH](https://space.bilibili.com/8417436)
"""


"""
ã€Šç»´æŠ¤æŒ‡å—ã€‹ï¼š
å¦‚æœä½ æƒ³ä¸ºwebuiä¸‰ä¸ªé€‰é¡¹å¡ä¸­ä»»æ„ä¸€ä¸ªé€‰é¡¹å¡æ·»åŠ ä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œå¹¶ä»¥å…¶å€¼æŒ‡å®štomlæ–‡ä»¶ç›¸åº”çš„å‚æ•°
1ã€
å»webuiéƒ¨åˆ†æ·»åŠ ç›¸åº”çš„ç»„ä»¶ä»£ç ï¼Œå¹¶ç»™æ–°çš„ç»„ä»¶å‘½åã€‚
**å¦‚ï¼šåœ¨commonå‚æ•°éƒ¨åˆ†æ·»åŠ  common_gr_dict["new_param"]= gr.Number(value=3)
2ã€
æ‰¾åˆ°parameter2toml()å‡½æ•°, ç¡®è®¤ä½ è¦å†™å…¥tomlæ–‡ä»¶çš„ä½ç½®ï¼Œæ¯”å¦‚è¯´ä½ æƒ³åœ¨[model_arguments]é”®ä¸‹é¢æ·»åŠ ä¸€ä¸ª new_param=3
é‚£ä¹ˆè¯·ç”¨model_arguments.update( "new_param":all.get("new_param")  )
æ³¨æ„è¿™é‡Œç”¨çš„æ˜¯allè¿™ä¸ªå­—å…¸ï¼Œå› ä¸ºåœ¨parameter2toml()ä¸€å¼€å§‹å°±ä¼šæŠŠä¸‰ä¸ªå…¨å±€å‚æ•°å­—å…¸åˆæˆä¸€ä¸ªallå­—å…¸
3ã€
å®Œæˆï¼Œæ£€æŸ¥ç”Ÿæˆçš„tomlæ˜¯å¦æ­£ç¡®
"""

#@title å‡½æ•°éƒ¨åˆ†


import os
import toml
import warnings
import gradio as gr
import argparse


""" ä»¥ä¸‹çš„å˜é‡ï¼Œæ ‡æ³¨gloabçš„æ˜¯è¦åœ¨å‡½æ•°å’Œwebuiéƒ¨åˆ†åŒæ—¶ä½¿ç”¨çš„ """

ROOT_DIR = os.getcwd()      #global

#ç”¨äºå‚¨å­˜é€‚ä¸‰ä¸ªé€‰é¡¹å¡ä¸­è¾“å…¥ç»„ä»¶çš„åå­—;  global
common_parameter_dict_key_list=[]
sample_parameter_dict_key_list=[]
plus_parameter_dict_key_list=[]
all_parameter_dict_key_list=[]  #åé¢ä¼šæœ‰ä¸€æ¬¡all_parameter_dict_key_list = common_parameter_dict_key_list + sample_parameter_dict_key_list + plus_parameter_dict_key_list
    
#ç”¨äºå‚¨å­˜æ‰€æœ‰ç¡®è®¤çš„ç»„ä»¶å€¼ï¼Œå¦‚è®­ç»ƒé›†åœ°å€ï¼› ï¼ˆåªä¼šåœ¨å‡½æ•°éƒ¨åˆ†ä½¿ç”¨ï¼‰
common_parameter_dict=({})
sample_parameter_dict=({})
plus_parameter_dict=({})

common_confirm_flag = False   #å¿…é¡»è¦ç¡®è®¤å¸¸è§„å‚æ•°ä¸€æ¬¡æ‰å…è®¸å†™å…¥tomlï¼› ï¼ˆåªä¼šåœ¨å‡½æ•°éƒ¨åˆ†ä½¿ç”¨ï¼‰

#ç”¨äºç¡®å®šæ¯ä¸ªé€‰é¡¹å¡ä¸­æŒ‰é”®çš„æ•°é‡ï¼Œæ–¹ä¾¿all_parameter_get;  global
parameter_len_dict={"common":0, "sample":0, "plus":0}       


def check_len_and_2dict(args, parameter_len_dict_value, parameter_dict_key_list, func_name=""):
    """ ä¸‰ä¸ªparameter_get()ä¼šæŠŠgradioç»„ä»¶çš„å€¼ä¼ è¿›æ¥ï¼Œæ£€æŸ¥ä¼ å…¥å€¼æ•°é‡å’Œparameter_len_dict_valueæ˜¯å¦ç›¸ç­‰ """
    """ ç›¸ç­‰åˆ™è¿”å›ä»¥parameter_dict_key_listä¸­å­—ç¬¦ä¸²åšä¸ºkeyåå­—çš„å­—å…¸ """
    """ ä¸ç›¸ç­‰å°±ç»™ä¸€ä¸ªwanring """
    if len(args) != parameter_len_dict_value:
        warnings.warn(f"ä¼ å…¥{func_name}çš„å‚æ•°é•¿åº¦ä¸åŒ¹é…", UserWarning)
    if len(parameter_dict_key_list) != parameter_len_dict_value:
        warnings.warn(f" {func_name}å†…éƒ¨å­—å…¸èµ‹å€¼å…³é”®å­—åˆ—è¡¨çš„é•¿åº¦ä¸åŒ¹é…", UserWarning)
    parameter_dict = dict(zip(parameter_dict_key_list, args))
    return parameter_dict


""" ä¸‹é¢ä¸‰ä¸ªå‡½æ•°ä¼šè·å–å„è‡ªé€‰é¡¹å¡ä¸­çš„è¾“å…¥å€¼ï¼Œç„¶åä½¿ç”¨å°†å…¶è½¬ä¸ºå­—å…¸å¹¶èµ‹å€¼ç»™å„è‡ªçš„å…¨å±€å˜é‡parameter_dict """
""" æœ€åè¿”å›webuiç›¸åº”çš„è¾“å‡ºä¿¡æ¯ """
def common_parameter_get(*args):
    global common_parameter_dict, common_confirm_flag
    common_confirm_flag = True    #å¿…é¡»è¦ç¡®è®¤å¸¸è§„å‚æ•°ä¸€æ¬¡æ‰å…è®¸å†™å…¥toml
    common_parameter_dict = check_len_and_2dict(args, parameter_len_dict["common"], common_parameter_dict_key_list, func_name="common_parameter_get")
    common_parameter_toml = toml.dumps(common_parameter_dict)
    common_parameter_title = "åŸºç¡€å‚æ•°é…ç½®ç¡®è®¤"
    return common_parameter_toml,  common_parameter_title

def sample_parameter_get(*args):
    global sample_parameter_dict
    sample_parameter_dict = check_len_and_2dict(args, parameter_len_dict["sample"], sample_parameter_dict_key_list, func_name="sample_parameter_get")
    sample_parameter_toml = toml.dumps(sample_parameter_dict)
    sample_parameter_title = "é‡‡æ ·é…ç½®ç¡®è®¤"
    return sample_parameter_toml,  sample_parameter_title


def plus_parameter_get(*args):
    global plus_parameter_dict
    plus_parameter_dict = check_len_and_2dict(args, parameter_len_dict["plus"], plus_parameter_dict_key_list, func_name="plus_parameter_get")
    plus_parameter_toml = toml.dumps(plus_parameter_dict)
    plus_parameter_title = "è¿›é˜¶å‚æ•°é…ç½®ç¡®è®¤"
    return plus_parameter_toml,  plus_parameter_title


"""  è°ƒç”¨ä¸Šé¢ä¸Šä¸ªå‡½æ•°æ¥ç¡®è®¤å…¨éƒ¨å‚æ•°å€¼ï¼Œå¹¶èµ‹å€¼ç»™ä¸‰ä¸ªå…¨å±€å­—å…¸parameter_dict """
def all_parameter_get(*args):
    if len(args) != sum( parameter_len_dict.values() ):
         warnings.warn("ä¼ å…¥all_parameter_getçš„å‚æ•°é•¿åº¦ä¸åŒ¹é…", UserWarning)
    """ é€šè¿‡parameter_len_dictå­—å…¸ä¸­è®°å½•çš„å„ä¸ªé€‰é¡¹å¡è¾“å…¥ç»„ä»¶æ•°é‡æ¥åˆ†é…ä¼ å…¥ä¸‰ä¸ªå­å‡½æ•°çš„å‚æ•° """
    common_parameter_toml,  common_parameter_title = common_parameter_get( *args[ : parameter_len_dict["common"] ] )
    sample_parameter_toml,  sample_parameter_title = sample_parameter_get( *args[ parameter_len_dict["common"] : parameter_len_dict["common"] + parameter_len_dict["sample"] ] )
    plus_parameter_toml,  plus_parameter_title = plus_parameter_get( *args[ -parameter_len_dict["plus"] : ] )
    return common_parameter_toml, sample_parameter_toml, plus_parameter_toml,  "å…¨éƒ¨å‚æ•°ç¡®è®¤"

                      
def save_webui_config(save_webui_config_dir, save_webui_config_name, write_files_dir):
    """ ä¿å­˜å½“å‰å·²ç»ç¡®è®¤ï¼ˆåœ¨ä¸‰ä¸ªå‚æ•°å­—å…¸ä¸­ï¼Œè€Œä¸æ˜¯webuiä¸­ç»„ä»¶å€¼ï¼‰çš„é…ç½®å‚æ•° """
    
    if not common_confirm_flag:
        return "å¿…é¡»è¦ç¡®è®¤å¸¸è§„å‚æ•°ä¸€æ¬¡æ‰å…è®¸ä¿å­˜!"
    
    os.makedirs(save_webui_config_dir, exist_ok=True)
    
    other = {"write_files_dir":write_files_dir}
    param = {**common_parameter_dict, **sample_parameter_dict, **plus_parameter_dict}
    dict = { "other":other, "param":param }

    save_webui_config_path = os.path.join(save_webui_config_dir, save_webui_config_name)
    with open(save_webui_config_path, "w", encoding="utf-8") as f:
        webui_config_str = toml.dumps( dict )
        f.write(webui_config_str)
    return f"ä¿å­˜webuié…ç½®æˆåŠŸï¼Œæ–‡ä»¶åœ¨{save_webui_config_path}"

def read_webui_config_get(read_webui_config_dir):
    """ è¯»å–ç›®å½•ä¸‹ä»¥.tomlç»“å°¾çš„æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªè¯»å–åˆ°çš„æ–‡ä»¶listæ¥æ›´æ–°gradioç»„ä»¶ """
    try:
        files = [f for f in os.listdir(read_webui_config_dir) if os.path.isfile(os.path.join(read_webui_config_dir, f)) and f.endswith(".toml") ]
        if files:
            return gr.update( choices=files,value=files[0] )
        else:
            return gr.update( choices=[],value="æ²¡æœ‰æ‰¾åˆ°webuié…ç½®æ–‡ä»¶" )
    except Exception as e:
        return gr.update( choices=[], value=f"é”™è¯¯çš„æ–‡ä»¶å¤¹è·¯å¾„:{e}" )
    
def read_webui_config(read_webui_config_dir, read_webui_config_name, write_files_dir, *args):
    """ è¯»å–é¢„å…ˆä¿å­˜çš„configæ–‡ä»¶ï¼Œæ¥æ›´æ–°webuiç•Œé¢(æ³¨æ„ï¼Œä¸æ›´æ–°å‚æ•°å­—å…¸ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤) """
    
    dir_change_flag = False         #è¯»å–å®Œä¿å­˜çš„configæ–‡ä»¶åä¼šä¿®æ”¹å†™å…¥æ–‡ä»¶å¤¹è¿™ä¸€ç»„ä»¶ï¼Œè¿™é‡Œä¼šåˆ¤æ–­æ˜¯å¦ä¿®æ”¹ï¼Œå¦‚ä¿®æ”¹ç»™webuiä¸€ä¸ªæç¤º
    #æ£€æŸ¥ä¼ å…¥çš„æ›´æ–°ç»„ä»¶æ•°é‡æ˜¯å¦å’Œwebuiä¸­ä¸€è‡´
    param_len = sum( parameter_len_dict.values() )
    if len(args) != param_len:
        warnings.warn("ä¼ å…¥read_webui_configçš„*argsé•¿åº¦ä¸åŒ¹é…", UserWarning)

    read_webui_config_path = os.path.join(read_webui_config_dir, read_webui_config_name)
    #èƒ½æ‰“å¼€å°±æ­£å¸¸æ“ä½œ
    try:
        with open(read_webui_config_path, "r", encoding="utf-8") as f:
            config_dict = toml.loads( f.read() )
        
        #èƒ½è¯»åˆ°["other"].["write_files_dir"]å°±æ”¹ï¼Œè¯»ä¸åˆ°å°±ç”¨åŸå†™å…¥åœ°å€
        try:
            if config_dict["other"]["write_files_dir"] != write_files_dir:
                write_files_dir = config_dict["other"]["write_files_dir"]
                dir_change_flag = True
        except KeyError:
            pass
        
        param_dict_key_list = list( config_dict.get("param",{}).keys() )
        #æ‰¾å‡ºå…±æœ‰çš„keyè¿›è¡Œèµ‹å€¼ï¼Œéå…±æœ‰çš„æŠ¥é”™
        both_key = set(all_parameter_dict_key_list) & set(param_dict_key_list)
        parameter_unique_key = set(all_parameter_dict_key_list) - set(both_key)
        config_unique_key = set(param_dict_key_list) - set(both_key)
        
        
        
        #å¯¹å…±æœ‰çš„ç»„ä»¶è¿›è¡Œèµ‹å€¼
        count = 0
        if both_key:
            args = list(args)
            for key in both_key:
                index = all_parameter_dict_key_list.index(key)
                args[ index ] = config_dict["param"][key]
                count += 1
            
            def get_files_name_list(files_dir:str) -> list:
                """
                è¯»å–dirè·¯å¾„ä¸‹çš„å…¨éƒ¨æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ 
                ç”¨äºæ›´æ–°base_model_nameå’Œvae_model_nameç»„ä»¶
                """
                try:
                    #å°è¯•è¯»å–
                    files = [ f for f in os.listdir(files_dir) if os.path.isfile(os.path.join(files_dir, f)) ]
                    #è¯»å–åˆ°äº†å°±è¿”å›
                    if files:
                        return files
                    #è¯»å–ä¸åˆ°å°±è¿”å›ç©ºå­—ç¬¦ä¸²åˆ—è¡¨
                    else:
                        return [""]
                except Exception:
                    #è¯»å–ä¸åˆ°å°±è¿”å›ç©ºå­—ç¬¦ä¸²åˆ—è¡¨
                    return [""]
                
            def update_gr_model_list(model_dir_gr_name:str, model_name_gr_name:str):
                #å¦‚æœä¿å­˜çš„webuiç»„ä»¶configæ–‡ä»¶ä¸­æœ‰æ¨¡å‹è·¯å¾„çš„è®°å½•
                if model_dir_gr_name in both_key:
                    #å°±å°è¯•è¯»å–è¯¥è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
                    model_name_list = get_files_name_list( config_dict["param"][model_dir_gr_name] )
                    #å¦‚æœmodel_nameåœ¨è¿™ä¸ªåˆ—è¡¨ä¸­ï¼Œå°±ä¿æŒï¼›å¦‚æœä¸åœ¨ï¼Œå°±ä¸ºåˆ—è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ 
                    model_name = config_dict.get("param",{}).get(model_name_gr_name,"")
                    model_name = model_name if model_name in model_name_list else model_name_list[0]
                    #æ‰¾åˆ°è¯¥grç»„ä»¶åœ¨argsä¸­çš„ç´¢å¼•
                    index = all_parameter_dict_key_list.index(model_name_gr_name)
                    args[ index ] = gr.update( choices=model_name_list, value=model_name  )
            
            update_gr_model_list("base_model_dir", "base_model_name")
            update_gr_model_list("vae_model_dir", "vae_model_name")
            
            args = tuple(args)
            
 
        read_done = f"\nè¯»å–å®Œæˆ,WebUIä¸­å…±æœ‰{param_len}é¡¹å‚æ•°,æ›´æ–°äº†å…¶ä¸­{count}é¡¹\n" + (f"å†™å…¥æ–‡ä»¶å¤¹å‘ç”Ÿæ”¹å˜:{write_files_dir}" if dir_change_flag else "")
        config_warning = f"\nwebui-configæ–‡ä»¶ä¸­ä»¥ä¸‹å‚æ•°å¯èƒ½å·²ç»å¤±æ•ˆæˆ–é”™è¯¯ï¼š\n{config_unique_key}\n" if config_unique_key else ""
        parameter_warning = f"\nWebUIä¸­ä»¥ä¸‹å‚æ•°åœ¨webui-configæ–‡ä»¶ä¸­æœªæ‰¾åˆ°ï¼Œä¸å‘ç”Ÿä¿®æ”¹ï¼š\n{parameter_unique_key}\n" if parameter_unique_key else ""
        read_str = f"{read_done}{config_warning}{parameter_warning}"
        return  read_str, write_files_dir, *args

    #æ‰“ä¸å¼€å°±è¿”å›åŸå€¼
    except FileNotFoundError:
        return "æ–‡ä»¶æˆ–ç›®å½•ä¸å­˜åœ¨", write_files_dir, *args
    except PermissionError:
        return "æ²¡æœ‰æƒé™è®¿é—®æ–‡ä»¶æˆ–ç›®å½•", write_files_dir, *args
    except OSError as e:
        return f"something wrongï¼š{e}", write_files_dir, *args
    
    

def model_get(model_dir):
    """ è¯»å–æ–‡ä»¶å¤¹ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ """
    try:
        #files = [f for f in os.listdir(model_dir) if os.path.isfile(os.path.join(model_dir, f)) and f.endswith(("ckpt", "pt", "safetensors")) ]
        files = [f for f in os.listdir(model_dir) if os.path.isfile(os.path.join(model_dir, f))]
        if files:
            return gr.update( choices=files,value=files[0] )
        else:
            return gr.update( choices=[],value="æ²¡æœ‰æ‰¾åˆ°æ¨¡å‹" )
    except Exception as e:
        return gr.update( choices=[], value=f"é”™è¯¯çš„æ–‡ä»¶å¤¹è·¯å¾„:{e}" )


def write_files(write_files_dir):
    """ ç”¨å‚æ•°å­—å…¸ç”Ÿæˆä¸ºkohyaè®­ç»ƒè„šæœ¬è¦æ±‚çš„tomlæ ¼å¼æ–‡ä»¶ """

    if not common_confirm_flag:
        return "å¿…é¡»è¦ç¡®è®¤å¸¸è§„å‚æ•°ä¸€æ¬¡æ‰å…è®¸å†™å…¥toml"

    write_files_dir = write_files_dir if write_files_dir else os.path.join(ROOT_DIR, "kohya_config")
    os.makedirs(write_files_dir, exist_ok=True)
    config_file_toml_path = os.path.join(write_files_dir, "config_file.toml")
    sample_prompts_txt_path = os.path.join(write_files_dir, "sample_prompts.txt")

    all = {**common_parameter_dict, **sample_parameter_dict, **plus_parameter_dict}

    def parameter2toml():

        #ç”Ÿæˆconfig_file.tomlçš„å­—å…¸

        #model_argumentséƒ¨åˆ†
        model_arguments = { key: all.get(key) for key in ["v2", "v_parameterization"] }
        """ ç”Ÿæˆåº•æ¨¡è·¯å¾„ """
        base_model_path = os.path.join( all.get("base_model_dir"), all.get("base_model_name") )
        model_arguments.update( {"pretrained_model_name_or_path": base_model_path} )
        """ ç”Ÿæˆvaeè·¯å¾„ """
        if all.get("use_vae"):
            vae_model_path = os.path.join( all.get("vae_model_dir"), all.get("vae_model_name") )
            model_arguments.update( {"vae": vae_model_path} )

        #additional_network_argumentséƒ¨åˆ†
        additional_network_arguments = { key: all.get(key) for key in ["unet_lr", "text_encoder_lr", "network_dim",\
                                            "network_alpha", "network_train_unet_only",\
                                            "network_train_text_encoder_only"] }
        """ ç”Ÿæˆå¦‚network_module = "locon.locon_kohya" """
        #ä¸»è¦è´Ÿè´£network_moduleçš„å‚æ•°ç”Ÿæˆ
        
        kohya_list = ["LoRA-LierLa", "LoRA-C3Lier"]
        lycoris_list = ["LoCon_Lycoris", "LoHa_Lycoris", "IA3_Lycoris", "LoKR_Lycoris"]
        dylora_list = ["DyLoRa-LierLa", "DyLoRa-C3Lier"]
        
        algo_list = ["lora", "loha", "ia3", "lokr"]
            
        def network_module_param(train_method):
            
            #train_methodå¯èƒ½å€¼å¦‚ä¸‹
            #["LoRA-LierLa", "LoRA-C3Lier", "LoCon_Lycoris", "LoHa_Lycoris", "IA3_Lycoris", "LoKR_Lycoris", "DyLoRa-LierLa", "DyLoRa-C3Lier"]
            
            #å·ç§¯DyLoRaä¸“é—¨æŒ‡å®šdimç›¸åŒ
            conv_dim = all.get("conv_dim") if train_method != "DyLoRa-C3Lier" else all.get("network_dim")
            conv_alpha = all.get("conv_alpha")
            
            unit = all.get("unit")
            
            #kohyaç½‘ç»œ
            if train_method in kohya_list:
                network_module = "networks.lora"
                if train_method == "LoRA-C3Lier":
                    network_module_args = [f"conv_dim={conv_dim}", f"conv_alpha={conv_alpha}"]
                else:
                    network_module_args = []
            #lycorisç½‘ç»œ
            elif train_method in lycoris_list:
                algo = algo_list[ lycoris_list.index(train_method) ]
                network_module = "lycoris.kohya"
                network_module_args = [f"conv_dim={conv_dim}", f"conv_alpha={conv_alpha}", f"algo={algo}"]
            #dyloraç½‘ç»œ
            elif train_method in dylora_list:
                network_module = "networks.dylora"
                if train_method == "DyLoRa-C3Lier":
                    network_module_args = [f"conv_dim={conv_dim}", f"conv_alpha={conv_alpha}", f"unit={unit}"]
                else:
                    network_module_args = [f"unit={unit}"]
            else: 
                warnings.warn("è®­ç»ƒæ–¹æ³•å‚æ•°ç”Ÿæˆå‡ºé”™", UserWarning)
                
            return network_module, network_module_args
        
        network_module, network_module_args = network_module_param( all.get("train_method") )
        #æ›´å¤šnetwork_argséƒ¨åˆ†ï¼ˆä¸»è¦ä¸ºåˆ†å±‚è®­ç»ƒï¼‰
        network_lr_weight_args = [ f"{name}={all.get(name)}" for name in ["down_lr_weight", "mid_lr_weight", "up_lr_weight"] if all.get(name) ]

        def network_block_param(train_method):
            #dyloraä¸å…è®¸åˆ†å±‚
            lst = ["block_dims", "block_alphas", "conv_block_dims", "conv_block_alphas"]
            if train_method == "LoRA-LierLa":
                return [ f"{name}={all.get(name)}" for name in lst[0:1] if all.get(name) ]
            if train_method in ["LoRA-C3Lier"] + lycoris_list:
                return [ f"{name}={all.get(name)}" for name in lst if all.get(name) ]
            else:
                return []
            
        network_block_args = network_block_param( all.get("train_method") )
        
        #åˆæˆç½‘ç»œå‚æ•°ã€åˆ†å±‚å‚æ•°
        network_args = []
        network_args.extend(network_module_args)
        network_args.extend(network_lr_weight_args)
        network_args.extend(network_block_args)

        additional_network_arguments.update( { "network_module":network_module } )
        additional_network_arguments.update( {"network_args":network_args} )          


        #optimizer_argumentséƒ¨åˆ†
        optimizer_arguments = { key: all.get(key) for key in ["optimizer_type", "lr_scheduler", "lr_warmup_steps"] }
        """åªæœ‰ä½™å¼¦é‡å¯è°ƒåº¦å™¨æŒ‡å®šé‡å¯æ¬¡æ•°"""
        if all.get("lr_scheduler") == "cosine_with_restarts":
            optimizer_arguments.update( {"lr_restart_cycles":all.get("lr_restart_cycles")} )
        """å­¦ä¹ ç‡lræŒ‡å®š=unet_lr"""
        optimizer_arguments.update( {"learning_rate":all.get("unet_lr")} )
        """ optimizer_args """
        optimizer_args_str = all.get("optimizer_args", "")
        if optimizer_args_str:
            optimizer_arguments.update( { "optimizer_args": [ x.strip() for x in optimizer_args_str.rstrip(", ").split(",") ] } )


        #dataset_argumentséƒ¨åˆ†
        dataset_arguments = { key: all.get(key) for key in ["cache_latents", "cache_latents_to_disk", "shuffle_caption",\
                                                            "enable_bucket", "weighted_captions"] }
        
        
        #training_argumentséƒ¨åˆ†
        training_arguments = { key: all.get(key) for key in ["train_batch_size", "noise_offset", "keep_tokens",\
                                      "min_bucket_reso", "max_bucket_reso",\
                                      "caption_extension", "max_token_length", "seed",\
                                      "xformers", "lowram",\
                                      "gradient_checkpointing","gradient_accumulation_steps"]
        }
        """min_snr_gammaå¤§äºé›¶æ‰ç”Ÿæ•ˆ"""
        if all.get("min_snr_gamma") > 0:
            training_arguments.update( { "min_snr_gamma":all.get("min_snr_gamma") } )
        """ æœ€å¤§è®­ç»ƒæ—¶é—´ """
        training_arguments.update( { all.get("max_train_method"):all.get("max_train_value") } )
        """ è®­ç»ƒåˆ†è¾¨ç‡ """
        training_arguments.update( { "resolution":f"{all.get('width')},{all.get('height')}" } )
        """ å¦‚æœv2å¼€å¯ï¼Œåˆ™ä¸æŒ‡å®šclip_skip """
        if not all.get("v2"):
            training_arguments.update( { "clip_skip":all.get("clip_skip") } )
        """ é‡è®­ç»ƒæ¨¡å— """
        if all.get("use_retrain") == "model":
            training_arguments.update( { "network_weights":all.get("retrain_dir") } )
        elif all.get("use_retrain") == "state":
            training_arguments.update( { "resume":all.get("retrain_dir") } )
        """  è®­ç»ƒç²¾åº¦ã€ä¿å­˜ç²¾åº¦ """
        training_arguments.update( { "mixed_precision":"fp16" } )
        training_arguments.update( { "save_precision":"fp16" } )
        


        #sample_prompt_argumentséƒ¨åˆ†ï¼ˆé‡‡æ ·é—´éš”ï¼Œé‡‡æ ·æ–‡ä»¶åœ°å€å¾…æ·»åŠ ï¼‰
        sample_prompt_arguments = { key: all.get(key) for key in ["sample_sampler"] }
        if all.get("sample_every_n_type"):    #å¦‚æœé‡‡æ ·éƒ¨åˆ†æ²¡ç¡®è®¤è¿‡ä¸€æ¬¡ï¼Œä¼šå‡ºç°all.get("sample_every_n_type")=None:Noneçš„å­—å…¸é€ æˆæŠ¥é”™
            sample_prompt_arguments.update( {all.get("sample_every_n_type"):all.get("sample_every_n_type_value")} )


        #dreambooth_argumentséƒ¨åˆ†
        def creat_dreambooth_arguments_list(use_reg:bool) -> list:
            if use_reg:
                return ["train_data_dir", "reg_data_dir", "prior_loss_weight"]
            else:
                return ["train_data_dir"]
            
        dreambooth_arguments = { key: all.get(key) for key in creat_dreambooth_arguments_list( all.get("use_reg") ) }


        #saving_argumentséƒ¨åˆ†
        saving_arguments = { key: all.get(key) for key in ["output_name", "save_every_n_epochs", "save_n_epoch_ratio",\
                                      "save_last_n_epochs", "save_state", "save_model_as" ]
        }
        """åœ¨è¾“å‡ºæ–‡ä»¶å¤¹output_diråé¢åŠ ä¸Šoutput_name"""
        output_dir = os.path.join( all.get("output_dir"), all.get("output_name") )
        saving_arguments.update( {"output_dir":output_dir } )
        """ æŒ‡å®šlogè¾“å‡ºç›®å½•ä¸outputç›¸åŒ """
        saving_arguments.update( { "logging_dir":os.path.join( output_dir, "logs" ) } )
        """ æŒ‡å®šlogå‰ç¼€å’Œè¾“å‡ºåå­—ç›¸åŒ """
        saving_arguments.update( { "log_prefix":all.get("output_name") } )
        """ å¯ç”¨wandb"""
            #å†³å®šlogè®°å½•æ–¹å¼
        if all.get("use_wandb"):
            saving_arguments.update( { "log_with":"all" } )
        else:
            saving_arguments.update( { "log_with":"tensorboard" } )
            #api_keyå’Œlog_tracker_nameçš„æŒ‡å®š
        if all.get("wandb_api_key"):
            saving_arguments.update( { "wandb_api_key":all.get("wandb_api_key") } )
        if all.get("log_tracker_name"):
            saving_arguments.update( { "log_tracker_name":all.get("log_tracker_name") } )
            
            
        #self_argumentséƒ¨åˆ†
        try:
            self_arguments = toml.loads( all.get("self_arguments") )
        except Exception:
            self_arguments = {}
                
                
        ##åˆæˆæ€»å­—å…¸
        toml_dict = {"model_arguments":model_arguments,
               "additional_network_arguments":additional_network_arguments,
               "optimizer_arguments":optimizer_arguments,
               "dataset_arguments":dataset_arguments,
               "training_arguments":training_arguments,
               "sample_prompt_arguments":sample_prompt_arguments,
               "dreambooth_arguments":dreambooth_arguments,
               "saving_arguments":saving_arguments,
               "self_arguments":self_arguments,
        }
        toml_str = toml.dumps(toml_dict)
        return toml_str
    
    def sample_parameter2txt():
        #key_list = ["prompt", "negative", "sample_width", "sample_height", "sample_scale", "sample_steps", "sample_seed"]
        
        #å¦‚æœé‡‡æ ·éƒ¨åˆ†æ²¡ç¡®è®¤è¿‡ï¼Œè¿™ä¸ªå€¼=Noneï¼›æˆ–è€…æ²¡å†™ä»»ä½•promptï¼›å°±ç›´æ¥é€€å‡º,è¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²
        if not all.get("prompt"):
            return ""
        #å…è®¸åˆ†è¡Œ
        prompt = all.get("prompt").replace("\n", "")
        negative = all.get("negative").replace("\n", "")
        #ç”Ÿæˆé‡‡æ ·æ–‡ä»¶str
        sample_str = f"""{prompt}  \
--n {negative}  \
--w {all.get("sample_width")}  \
--h {all.get("sample_height")}  \
--l {all.get("sample_scale")}  \
--s {all.get("sample_steps")}  \
{f"--d {all.get('sample_seed')}" if all.get('sample_seed') > 0 else ""}"""
        return sample_str

    def write(content, path):
        with open(path, "w", encoding="utf-8") as f:
            f.write(content)

    write(parameter2toml(), config_file_toml_path)
    write(sample_parameter2txt(), sample_prompts_txt_path)
    write_files_title = f"å†™å…¥æˆåŠŸ, è®­ç»ƒé…ç½®æ–‡ä»¶åœ¨{config_file_toml_path} , é‡‡æ ·å‚æ•°æ–‡ä»¶åœ¨{sample_prompts_txt_path}"
    return write_files_title

#@title WebUIéƒ¨åˆ†
def create_demo(parser_input:list=[]):
    
    #ç”¨å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šé»˜è®¤webuiç»„ä»¶configä¿å­˜ã€è¯»å†™è·¯å¾„å’Œåå­—
    parser = argparse.ArgumentParser()

    DEFAULT_SAVE_AND_READ_DIR = os.path.join(ROOT_DIR, "kohya_config_webui_save")

    parser.add_argument("--save_dir", type=str, default=DEFAULT_SAVE_AND_READ_DIR, help="webuiç»„ä»¶configé»˜è®¤ä¿å­˜è·¯å¾„")
    parser.add_argument("--save_name", type=str, default="kohya_config_webui_save.toml", help="webuiç»„ä»¶configé»˜è®¤ä¿å­˜åå­—")
    parser.add_argument("--read_dir", type=str, default=DEFAULT_SAVE_AND_READ_DIR, help="webuiç»„ä»¶configé»˜è®¤è¯»å–è·¯å¾„")
    #parser.add_argument("--read_name", type=str, default="kohya_config_webui_save.toml", help="webuiç»„ä»¶configé»˜è®¤è¯»å–åå­—")
    
    #å¦‚æœç›´æ¥è°ƒç”¨å°±è·å–å‘½ä»¤è¡Œå‚æ•°
    if __name__ == "__main__":
        cmd_param, unknown = parser.parse_known_args()
    #å¦‚æœæ˜¯è¢«å¯¼å…¥ï¼Œå°±ç”±create_demo(parser_input:list=[])æ¥æŒ‡å®šå‚æ•°
    else:
        cmd_param, unknown = parser.parse_known_args(parser_input)
    
    #å›¾æ ‡å¸¸é‡
    """
    random_symbol = '\U0001f3b2\ufe0f'  # ğŸ²ï¸
    reuse_symbol = '\u267b\ufe0f'  # â™»ï¸
    paste_symbol = '\u2199\ufe0f'  # â†™
    save_style_symbol = '\U0001f4be'  # ğŸ’¾
    apply_style_symbol = '\U0001f4cb'  # ğŸ“‹
    clear_prompt_symbol = '\U0001f5d1\ufe0f'  # ğŸ—‘ï¸
    extra_networks_symbol = '\U0001F3B4'  # ğŸ´
    switch_values_symbol = '\U000021C5' # â‡…
    folder_symbol = '\U0001f4c2'  # ğŸ“‚
    """
    refresh_symbol = '\U0001f504'  # ğŸ”„
    
    #å…¨å±€å˜é‡
    global common_parameter_dict_key_list
    global sample_parameter_dict_key_list
    global plus_parameter_dict_key_list
    global all_parameter_dict_key_list
    global parameter_len_dict
    
    #ç”¨äºå‚¨å­˜ç»„ä»¶å˜é‡ï¼Œæ–¹ä¾¿å‘botton.clickå‡½æ•°ä¼ é€’
    common_gr_dict = {}
    sample_gr_dict = {}
    plus_gr_dict = {}
    all_gr_dict ={}     #åé¢ä¼šæœ‰ä¸€æ¬¡æŠŠä¸‰ä¸ªå­—å…¸åˆèµ·æ¥
    
    def init_gr_read_name(dir:str) -> list:
        """
        è¯»å–dirè·¯å¾„ä¸‹ä»¥.tomlçš„æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ 
        ç”¨äºåˆå§‹åŒ–read_webui_config_nameç»„ä»¶
        """
        try:
            #å°è¯•è¯»å–
            files = [ f for f in os.listdir(dir) if os.path.isfile(os.path.join(dir, f)) and f.endswith(".toml") ]
            #è¯»å–åˆ°äº†å°±è¿”å›
            if files:
                return files
            #è¯»å–ä¸åˆ°å°±è¿”å›ç©ºå­—ç¬¦ä¸²åˆ—è¡¨
            else:
                return [""]
        except Exception:
            #è¯»å–ä¸åˆ°å°±è¿”å›ç©ºå­—ç¬¦ä¸²åˆ—è¡¨
            return [""]
    
    with gr.Blocks() as demo:
        gr.Markdown("æ›´æ–°æ—¶é—´2023å¹´4æœˆ26ï¼Œå¦‚æœæ–°å‚æ•°ç”¨ä¸äº†ï¼Œè¯·ä¿è¯kohyaç‰ˆæœ¬åœ¨æ›´æ–°æ—¶é—´å")
        with gr.Accordion("ä¿å­˜ã€è¯»å–\nwebuié…ç½®", open=False):
            save_read_webui_config_title = gr.Markdown("ä¿å­˜æˆ–è¯»å–")
            with gr.Row():
                save_webui_config_button = gr.Button("ä¿å­˜(è®°å¾—å…ˆç¡®è®¤ï¼)")
            with gr.Row():
                save_webui_config_dir = gr.Textbox(lines=1, label="ä¿å­˜ç›®å½•", value=cmd_param.save_dir )
                save_webui_config_name = gr.Textbox(lines=1, label="ä¿å­˜åå­—ï¼ˆä»¥tomlä¸ºæ‰©å±•åï¼Œå¦åˆ™ä¸ä¼šè¢«è¯»å–ï¼‰", value=cmd_param.save_name )
            with gr.Row():
                read_webui_config_get_button = gr.Button(refresh_symbol)
                read_webui_config_button = gr.Button("è¯»å–")
            with gr.Row():
                read_webui_config_dir = gr.Textbox(lines=1, label="è¯»å–ç›®å½•", value=cmd_param.read_dir )  
                read_webui_config_name = gr.Dropdown(choices=init_gr_read_name(cmd_param.read_dir),
                                                     label="è¯»å–æ–‡ä»¶",
                                                     value=init_gr_read_name(cmd_param.read_dir)[0] )
        with gr.Row():
            write_files_button = gr.Button("ç”Ÿæˆtomlå‚æ•°ä¸é‡‡æ ·é…ç½®æ–‡ä»¶")
            all_parameter_get_button = gr.Button("å…¨éƒ¨å‚æ•°ç¡®è®¤")
            write_files_dir = gr.Textbox( lines=1, label="å†™å…¥æ–‡ä»¶å¤¹", placeholder="ä¸€èˆ¬å¡«kohya_scriptç›®å½•ï¼Œç•™ç©ºå°±é»˜è®¤æ ¹ç›®å½•ä¸‹çš„kohya_configæ–‡ä»¶å¤¹", value="" )
        write_files_title = gr.Markdown("ç”Ÿæˆé€‚ç”¨äºkohya/train_network.pyçš„é…ç½®æ–‡ä»¶")
        with gr.Tabs():
            with gr.TabItem("åŸºç¡€å‚æ•°"):
                common_parameter_get_button = gr.Button("ç¡®å®š")
                common_parameter_title = gr.Markdown("")
                with gr.Accordion("å½“å‰åŸºç¡€å‚æ•°é…ç½®", open=False):
                    common_parameter_toml = gr.Textbox(label="tomlå½¢å¼", placeholder="åŸºç¡€å‚æ•°", value="")
                with gr.Row():
                    common_gr_dict["train_data_dir"] = gr.Textbox(lines=1, label="train_data_dir", placeholder="è®­ç»ƒé›†è·¯å¾„", value="")
                with gr.Accordion("ä½¿ç”¨æ­£åˆ™åŒ–(å¯é€‰)", open=False):
                    with gr.Row():
                        common_gr_dict["use_reg"] = gr.Checkbox(label="æ˜¯å¦ä½¿ç”¨æ­£åˆ™åŒ–",value=False)
                    with gr.Row():
                        common_gr_dict["reg_data_dir"] = gr.Textbox(lines=1, label="reg_data_dir", placeholder="æ­£åˆ™åŒ–é›†è·¯å¾„ï¼ˆå¼€å¯æ‰æœ‰æ•ˆï¼‰", value="")
                        common_gr_dict["prior_loss_weight"] = gr.Slider(0, 1, step=0.01, value=0.3, label="æ­£åˆ™åŒ–æƒé‡")
                with gr.Row():
                    common_gr_dict["base_model_dir"] = gr.Textbox(label="åº•æ¨¡æ–‡ä»¶å¤¹åœ°å€", placeholder="æ–‡ä»¶å¤¹è·¯å¾„", value="")
                    common_gr_dict["base_model_name"] = gr.Dropdown(choices=[],label="åº•æ¨¡",value="")
                    base_model_get_button = gr.Button(refresh_symbol)
                with gr.Accordion("ä½¿ç”¨vae(å¯é€‰)", open=False):
                    with gr.Row():
                        common_gr_dict["use_vae"] = gr.Checkbox(label="æ˜¯å¦ä½¿ç”¨vae",value=False)
                    with gr.Row():
                        common_gr_dict["vae_model_dir"] = gr.Textbox(label="vaeæ–‡ä»¶å¤¹åœ°å€", placeholder="æ–‡ä»¶å¤¹è·¯å¾„", value="")
                        common_gr_dict["vae_model_name"] = gr.Dropdown(choices=[],label="vae", value="")
                        vae_model_get_button = gr.Button(refresh_symbol)
                with gr.Row():
                    common_gr_dict["width"]= gr.Slider(64, 1920, step=64, value=512, label="è®­ç»ƒåˆ†è¾¨ç‡ï¼ˆå®½ï¼‰width")
                    common_gr_dict["height"] = gr.Slider(64, 1920, step=64, value=512, label="è®­ç»ƒåˆ†è¾¨ç‡ï¼ˆé«˜ï¼‰height")
                    common_gr_dict["train_batch_size"] = gr.Slider(1, 24, step=1, value=1, label="batchå¤§å°")
                with gr.Row():
                    common_gr_dict["noise_offset"] = gr.Slider(0, 1, step=0.01, value=0.05, label="noise_offset")
                    common_gr_dict["keep_tokens"] = gr.Slider(0, 225, step=1, value=0, label="keep_tokens")
                    common_gr_dict["min_snr_gamma"] = gr.Slider(0, 100, step=0.1, value=5, label="min_snr_gamma(è®¾ç½®ä¸º0åˆ™ä¸ç”Ÿæ•ˆ)")
                """
                with gr.Row():
                    gr.Markdown("repeat * å›¾ç‰‡æ•° = æ¯ä¸ªepochçš„stepsæ•°")
                """
                with gr.Row():
                    common_gr_dict["max_train_method"] = gr.Dropdown(["max_train_epochs","max_train_steps"], label="ä»¥epochsæˆ–stepsæ¥æŒ‡å®šæœ€å¤§è®­ç»ƒæ—¶é—´", value="max_train_epochs")
                    common_gr_dict["max_train_value"] = gr.Number(label="æœ€å¤§è®­ç»ƒepochs\stepsæ•°", value=10, precision=0)
                with gr.Accordion("è¾“å‡ºè®¾ç½®", open=True):
                    with gr.Row():
                        common_gr_dict["output_dir"] = gr.Textbox( label="æ¨¡å‹ã€logæ—¥å¿—è¾“å‡ºåœ°å€ï¼ˆè‡ªè¡Œä¿®æ”¹ï¼‰", placeholder="æ–‡ä»¶å¤¹è·¯å¾„",value=os.path.join(ROOT_DIR,"output") )
                        common_gr_dict["output_name"] = gr.Textbox(label="è¾“å‡ºæ¨¡å‹åç§°ï¼ˆè‡ªè¡Œä¿®æ”¹ï¼‰", placeholder="åç§°",value="output_name")
                        common_gr_dict["save_model_as"] = gr.Dropdown(["safetensors","ckpt","pt"], label="ä¿å­˜æ¨¡å‹æ ¼å¼", value="safetensors")
                    with gr.Row():
                        common_gr_dict["save_every_n_epochs"] = gr.Slider(1, 499, step=1, value=1, label="æ¯nä¸ªepochä¿å­˜ä¸€æ¬¡")
                        common_gr_dict["save_n_epoch_ratio"] = gr.Slider(1, 499, step=1, value=0, label="ç­‰é—´éš”ä¿å­˜nä¸ª(å¦‚ä¸ä¸º0ï¼Œä¼šè¦†ç›–æ¯nä¸ªepochä¿å­˜ä¸€æ¬¡)")
                        common_gr_dict["save_last_n_epochs"] = gr.Slider(1, 499, step=1, value=499, label="æœ€å¤šä¿å­˜nä¸ªï¼ˆåé¢çš„å‡ºæ¥å°±ä¼šæŠŠå‰é¢åˆ äº†,ä¼˜å…ˆçº§æœ€é«˜ï¼‰")
                    with gr.Row():   
                        common_gr_dict["save_state"] = gr.Checkbox(label="ä¿å­˜å­¦ä¹ çŠ¶æ€",value=False)
                    with gr.Accordion(" * å¯ç”¨è¿œç¨‹è®°å½•", open=False):
                            with gr.Row():
                                gr.Markdown( "[ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°api_key](https://wandb.ai/authorize)")
                            with gr.Row():
                                common_gr_dict["use_wandb"] = gr.Checkbox(label="æ˜¯å¦ä½¿ç”¨wandbè¿œç¨‹è®°å½•", value= False)
                                common_gr_dict["wandb_api_key"] = gr.Textbox(label="wandb_api_key", placeholder="ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œæˆ–è€…éœ€è¦åˆ‡æ¢æ–°APIçš„æ—¶å€™ï¼Œè¯·å¡«å…¥", value="")
                                common_gr_dict["log_tracker_name"] = gr.Textbox(label="log_tracker_nameé¡¹ç›®åç§°", placeholder="ç•™ç©ºåˆ™æŒ‡å®šä¸ºnetwork_train",value="")
                with gr.Row():
                    common_gr_dict["optimizer_type"] = gr.Dropdown(["AdamW8bit", "Lion", "DAdaptation", "AdamW", "SGDNesterov", "SGDNesterov8bit", "AdaFactor"],\
                                    label="optimizer_typeä¼˜åŒ–å™¨ç±»å‹ï¼ˆDAä¼˜åŒ–å™¨ä¸¤ä¸ªå­¦ä¹ ç‡è¦ä¸€æ ·ï¼‰", value="AdamW8bit")
                    common_gr_dict["unet_lr"] = gr.Number(label="unetå­¦ä¹ ç‡", value=1e-4)
                    common_gr_dict["text_encoder_lr"] = gr.Number(label="text_encoderå­¦ä¹ ç‡", value=1e-5)
                with gr.Accordion("optimizer_argsä¼˜åŒ–å™¨å‚æ•°(ä¸ä¼šå°±ä¸è¦å¡«)", open=False):
                    common_gr_dict["optimizer_args"] = gr.Textbox(label="optimizer_args", placeholder="å¦‚æœä½ è¦å¡«ï¼Œå°±è¿™æ ·ï¼š decouple=True, weight_decay=0.5", value="")
                
                
                """ ä¸‹æ‹‰æ¡†è§¦å‘ """
                def __optimizer_arg(optimizer_type:str, optimizer_args:str) -> str:
                    if optimizer_type == "DAdaptation":
                        #return "decouple=True, weight_decay=0.5"
                        return "decouple=True"
                    else:
                        return optimizer_args
                optimizer_change_inputs = [ common_gr_dict["optimizer_type"], common_gr_dict["optimizer_args"] ]
                common_gr_dict["optimizer_type"].change(fn=__optimizer_arg, inputs=optimizer_change_inputs, outputs=common_gr_dict["optimizer_args"] )
                
                
                with gr.Row():
                    common_gr_dict["lr_scheduler"] = gr.Dropdown(["cosine_with_restarts","cosine","polynomial","linear","constant_with_warmup","constant"],\
                                   label="lr_schedulerå­¦ä¹ ç‡è°ƒåº¦å™¨", value="cosine_with_restarts")
                    common_gr_dict["lr_warmup_steps"] = gr.Number(label="å‡æ¸©æ­¥æ•°", value=0, precision=0)
                    common_gr_dict["lr_restart_cycles"] = gr.Number(label="é€€ç«é‡å¯æ¬¡æ•°", value=1, precision=0)
                with gr.Row():
                    common_gr_dict["train_method"] = gr.Dropdown(["LoRA-LierLa", "LoRA-C3Lier",\
                                    "LoCon_Lycoris", "LoHa_Lycoris",\
                                    "IA3_Lycoris", "LoKR_Lycoris",\
                                    "DyLoRa-LierLa", "DyLoRa-C3Lier"],\
                                    label="train_methodè®­ç»ƒæ–¹æ³•", value="LoRA-LierLa")
                    common_gr_dict["network_dim"] = gr.Number(label="çº¿æ€§dim", value=32, precision=0)
                    common_gr_dict["network_alpha"] = gr.Number(label="çº¿æ€§alphaï¼ˆå¯ä»¥ä¸ºå°æ•°ï¼‰", value=16)
                with gr.Accordion("é¢å¤–ç½‘ç»œå‚æ•°(LoRA-C3Lierã€LoConã€LoHaã€DyLoRa-C3Lieréƒ½å±äºå·ç§¯,unitä¸ºDyLoRaä¸“ç”¨)", open=True):
                    with gr.Row():
                        with gr.Column():
                            common_gr_dict["conv_dim"] = gr.Number(label="å·ç§¯dim", info="ä½¿ç”¨DyLoRa-C3Lieræ—¶ä¼šè¢«è®¾ç½®ä¸ºç­‰äºåŸºç¡€dim", value=8, precision=0)
                        with gr.Column():
                            common_gr_dict["conv_alpha"] = gr.Number(label="å·ç§¯alpha", info="å¯ä»¥ä¸ºå°æ•°", value=1)
                        with gr.Column():
                            common_gr_dict["unit"] = gr.Number(label="åˆ†å‰²å•ä½unit(æ•´æ•°)", info="ä½¿ç”¨DyLoRaæ—¶ï¼Œè¯·è®©dimä¸ºunitçš„å€æ•°", value=4, precision=0)
                with gr.Row():
                    common_gr_dict["v2"] = gr.Checkbox(label="v2")
                    common_gr_dict["v_parameterization"] = gr.Checkbox(label="v_parameterization")
                    common_gr_dict["lowram"] = gr.Checkbox(label="lowram")
                    common_gr_dict["xformers"] = gr.Checkbox(label="xformers",value=True)
                    common_gr_dict["shuffle_caption"] = gr.Checkbox(label="shuffle_caption",value=True)
                    common_gr_dict["enable_bucket"] = gr.Checkbox(label="enable_bucket",value=True)
                with gr.Row():  
                    common_gr_dict["cache_latents"] = gr.Checkbox(label="cache_latents", value=True, info="ç¼“å­˜latentsï¼Œæ³¨æ„å¼€å¯è¿™ä¸ªåŠŸèƒ½æ—¶ï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­å›¾åƒä¸èƒ½å‘ç”Ÿæ”¹å˜(æ¯”å¦‚å¢å¼ºAUG)")
                    common_gr_dict["cache_latents_to_disk"] = gr.Checkbox(label="cache_latents_to_disk", value=False, info="ç¼“å­˜latentsåˆ°ç¡¬ç›˜ï¼Œä¸‹æ¬¡ç›´æ¥è½½å…¥(éœ€è¦æŠŠcache_latentså¯ç”¨,ç¼“å­˜åä¸èƒ½æ”¹å˜å›¾åƒ)")
            with gr.TabItem("é‡‡æ ·å‚æ•°"):
                sample_parameter_get_button = gr.Button("ç¡®å®š")
                sample_parameter_title = gr.Markdown("")
                with gr.Accordion("å½“å‰é‡‡æ ·é…ç½®", open=False):
                    sample_parameter_toml = gr.Textbox(label="tomlå½¢å¼", placeholder="é‡‡æ ·é…ç½®", value="")
                with gr.Row():
                    #enable_sample = gr.Checkbox(label="æ˜¯å¦å¯ç”¨é‡‡æ ·åŠŸèƒ½")
                    sample_gr_dict["sample_every_n_type"] = gr.Dropdown(["sample_every_n_epochs", "sample_every_n_steps"], label="sample_every_n_type", value="sample_every_n_epochs")
                    sample_gr_dict["sample_every_n_type_value"] = gr.Number(label="sample_every_n_type_value", value=1, precision=0)
                with gr.Row():
                    sample_gr_dict["sample_sampler"] = gr.Dropdown(["ddim", "pndm", "lms", "euler", "euler_a", "heun",\
                                "dpm_2", "dpm_2_a", "dpmsolver","dpmsolver++", "dpmsingle",\
                                "k_lms", "k_euler", "k_euler_a", "k_dpm_2", "k_dpm_2_a"],\
                                label="é‡‡æ ·å™¨", value="euler_a")
                    sample_gr_dict["sample_seed"] = gr.Number(label="é‡‡æ ·ç§å­(-1ä¸æ˜¯éšæœºï¼Œå¤§äº0æ‰ç”Ÿæ•ˆ)", value=-1, precision=0)
                with gr.Row():
                    sample_gr_dict["sample_width"] = gr.Slider(64, 1920, step=64, value=512, label="é‡‡æ ·å›¾ç‰‡å®½")
                    sample_gr_dict["sample_height"] = gr.Slider(64, 1920, step=64, value=768, label="é‡‡æ ·å›¾ç‰‡é«˜")
                    sample_gr_dict["sample_scale"] = gr.Slider(1, 30, step=0.5, value=7, label="æç¤ºè¯ç›¸å…³æ€§")
                    sample_gr_dict["sample_steps"] = gr.Slider(1, 150, step=1, value=24, label="é‡‡æ ·è¿­ä»£æ­¥æ•°")
                with gr.Row():
                    sample_gr_dict["prompt"] = gr.Textbox(lines=10, label="prompt", placeholder="æ­£é¢æç¤ºè¯", value="(masterpiece, best quality, hires:1.2), 1girl, solo,")
                    default_negative_str = ("(worst quality, bad quality:1.4), "
                              "lowres, bad anatomy, bad hands, text, error, "
                              "missing fingers, extra digit, fewer digits, "
                              "cropped, worst quality, low quality, normal quality, "
                              "jpeg artifacts,signature, watermark, username, blurry,")
                    sample_gr_dict["negative"] = gr.Textbox(lines=10, label="negative", placeholder="è´Ÿé¢æç¤ºè¯", value=default_negative_str)
            with gr.TabItem("è¿›é˜¶å‚æ•°"):
                plus_parameter_get_button = gr.Button("ç¡®å®š")
                plus_parameter_title = gr.Markdown("")
                with gr.Accordion("å½“å‰è¿›é˜¶å‚æ•°é…ç½®", open=False):
                    plus_parameter_toml = gr.Textbox(label="tomlå½¢å¼", placeholder="è¿›é˜¶å‚æ•°", value="")
                with gr.Row():
                    plus_gr_dict["use_retrain"] = gr.Dropdown(["no","model","state"], label="æ˜¯å¦ä½¿ç”¨é‡è®­ç»ƒ", value="no")
                    plus_gr_dict["retrain_dir"] = gr.Textbox(lines=1, label="é‡è®­ç»ƒè·¯å¾„", placeholder="æ¨¡å‹æˆ–è€…çŠ¶æ€è·¯å¾„", value="")
                with gr.Row():
                    plus_gr_dict["weighted_captions"] = gr.Checkbox(label="å¼€å¯æƒé‡æ ‡",value=False,info="ä½ å¼€å¯äº†ï¼Œæœ€å¤§tokenå°±èƒ½75ä¸ª")
                    plus_gr_dict["min_bucket_reso"] = gr.Slider(64, 1920, step=64, value=256, label="æœ€ä½æ¡¶åˆ†è¾¨ç‡")
                    plus_gr_dict["max_bucket_reso"] = gr.Slider(64, 1920, step=64, value=1024, label="æœ€é«˜æ¡¶åˆ†è¾¨ç‡")
                    plus_gr_dict["clip_skip"] = gr.Slider(0, 25, step=1, value=2, label="è·³è¿‡å±‚æ•°")
                    plus_gr_dict["max_token_length"] = gr.Slider(75, 225, step=75, value=225, label="è®­ç»ƒæœ€å¤§tokenæ•°")
                    plus_gr_dict["caption_extension"] = gr.Textbox(lines=1, label="æ ‡ç­¾æ–‡ä»¶æ‰©å±•å", placeholder="ä¸€èˆ¬å¡«.txtæˆ–.cap", value=".txt")
                    plus_gr_dict["seed"] = gr.Number(label="ç§å­", value=1337, precision=0)
                with gr.Row():
                    plus_gr_dict["network_train_unet_only"] = gr.Checkbox(label="ä»…è®­ç»ƒunetç½‘ç»œ",value=False)
                    plus_gr_dict["network_train_text_encoder_only"] = gr.Checkbox(label="ä»…è®­ç»ƒtext_encoderç½‘ç»œ",value=False)
                with gr.Row():
                    plus_gr_dict["gradient_checkpointing"] = gr.Checkbox(label="gradient_checkpointing", value=False, info="é€æ­¥è®¡ç®—æƒé‡(ä¼šä½¿é€Ÿåº¦å˜æ…¢ï¼Œä½†å¯ä»¥ç”¨æ›´å¤§batch)")
                    plus_gr_dict["gradient_accumulation_steps"]= gr.Number(label="æ¢¯åº¦ç´¯ç§¯æ­¥æ•°ï¼ˆç´¯ç§¯næ­¥æ›´æ–°ä¸€æ¬¡æƒé‡ï¼‰", value=1, precision=0, info="ç­‰æ•ˆbatch = batch * gradient_accumulation_steps")
                with gr.Accordion("åˆ†å±‚å­¦ä¹ æ¨¡å—", open=True):
                    gr.Markdown("å­¦ä¹ ç‡åˆ†å±‚ï¼Œä¸ºä¸åŒå±‚çš„ç»“æ„æŒ‡å®šä¸åŒå­¦ä¹ ç‡å€æ•°ï¼› å¦‚æœæŸä¸€å±‚æƒé‡ä¸º0ï¼Œé‚£è¯¥å±‚ä¸ä¼šè¢«åˆ›å»º")
                    with gr.Row():
                        with gr.Column(scale=15):
                            plus_gr_dict["down_lr_weight"] = gr.Textbox(lines=1, label="INå±‚å­¦ä¹ ç‡æƒé‡", placeholder="ç•™ç©ºåˆ™ä¸å¯ç”¨",\
                                          info="12å±‚ï¼Œä¾‹å¦‚0.5,0.5,0.5,0.5,1.0,1.0,1.0,1.0,1.5,1.5,1.5,1.5", value="")
                        with gr.Column(scale=1):
                             plus_gr_dict["mid_lr_weight"] = gr.Textbox(lines=1, label="MIDå±‚å­¦ä¹ ç‡æƒé‡", placeholder="ç•™ç©ºåˆ™ä¸å¯ç”¨",\
                                           info="1å±‚ï¼Œä¾‹å¦‚2.0", value="")
                        with gr.Column(scale=15):
                            plus_gr_dict["up_lr_weight"] = gr.Textbox(lines=1, label="OUTå±‚å­¦ä¹ ç‡æƒé‡", placeholder="ç•™ç©ºåˆ™ä¸å¯ç”¨",\
                                          info="12å±‚ï¼Œä¾‹å¦‚1.5,1.5,1.5,1.5,1.0,1.0,1.0,1.0,0.5,0.5,0.5,0.5", value="")
                    with gr.Accordion(" * åˆ†å±‚ç¤ºä¾‹", open=False):
                        gr.Examples(examples = [ ["MIDD", "0,0,0,0,0,1,1,1,1,1,1,1", "1", "1,1,1,1,1,1,1,0,0,0,0,0"],\
                                                 ["OUTALL","0,0,0,0,0,0,0,0,0,0,0,0", "0", "1,1,1,1,1,1,1,1,1,1,1,1"],\
                                                 ["OUTD", "0,0,0,0,0,0,0,0,0,0,0,0", "0", "1,1,1,1,1,1,1,0,0,0,0,0"]    
                                    ],
                                    inputs = [ gr.Textbox(label="é¢„è®¾",visible=False), plus_gr_dict["down_lr_weight"], plus_gr_dict["mid_lr_weight"], plus_gr_dict["up_lr_weight"] ]
                        )
                    gr.Markdown("dimå’Œalphaåˆ†å±‚ï¼Œä¸ºä¸åŒå±‚çš„ç»“æ„æŒ‡å®šä¸åŒçš„dimå’Œalphaï¼ˆ`DyLoRa`æ— æ³•ä½¿ç”¨ï¼Œå·ç§¯åˆ†å±‚åªæœ‰`LoRa-C3Lierã€LoConã€LoHa`å¯ä»¥ä½¿ç”¨ï¼‰")
                    with gr.Row():
                            plus_gr_dict["block_dims"] = gr.Textbox(lines=1, label="çº¿æ€§dimåˆ†å±‚", placeholder="ç•™ç©ºåˆ™ä¸å¯ç”¨",\
                                          info="25å±‚ï¼ˆä¸Šä¸­ä¸‹ï¼‰ï¼Œä¾‹å¦‚2,4,4,4,8,8,8,8,12,12,12,12,16,12,12,12,12,8,8,8,8,4,4,4,2", value="")
                            plus_gr_dict["block_alphas"] = gr.Textbox(lines=1, label="çº¿æ€§alphaåˆ†å±‚", placeholder="ç•™ç©ºåˆ™ä¸å¯ç”¨",\
                                          info="25å±‚ï¼ˆä¸Šä¸­ä¸‹ï¼‰ï¼Œä¾‹å¦‚2,2,2,2,4,4,4,4,6,6,6,6,8,6,6,6,6,4,4,4,4,2,2,2,2", value="")
                    with gr.Row():
                            plus_gr_dict["conv_block_dims"] = gr.Textbox(lines=1, label="å·ç§¯dimåˆ†å±‚", placeholder="ç•™ç©ºåˆ™ä¸å¯ç”¨",\
                                            info="25å±‚ï¼ˆä¸Šä¸­ä¸‹ï¼‰ï¼Œä¾‹å¦‚2,2,2,2,4,4,4,4,6,6,6,6,8,6,6,6,6,4,4,4,4,2,2,2,2", value="")
                            plus_gr_dict["conv_block_alphas"] = gr.Textbox(lines=1, label="å·ç§¯alphaåˆ†å±‚", placeholder="ç•™ç©ºåˆ™ä¸å¯ç”¨",\
                                            info="25å±‚ï¼ˆä¸Šä¸­ä¸‹ï¼‰ï¼Œä¾‹å¦‚2,2,2,2,4,4,4,4,6,6,6,6,8,6,6,6,6,4,4,4,4,2,2,2,2", value="")
                    with gr.Row():
                            with gr.Accordion("é¢å¤–å‚æ•°(tomlæ ¼å¼)", open=False):
                                check_self_arguments_title = gr.Markdown("")
                                chek_self_arguments_botton = gr.Button("æ ¼å¼æ£€æŸ¥ï¼Œå¦‚æœä½ æ ¼å¼é”™äº†ï¼Œåˆ°æ—¶å€™å†™å…¥æ–‡ä»¶æ—¶æ•´ä¸ªè‡ªå®šä¹‰å‚æ•°éƒ½æ— æ•ˆ")
                                self_arguments_placeholder_str = "å¦‚æœä½ è¦ç”¨ï¼ŒæŒ‰ä¸‹é¢é‚£æ ·çš„tomlæ ¼å¼å¡«ï¼Œä»¥è¡Œä¸ºåˆ†éš”:"
                                plus_gr_dict["self_arguments"] = gr.Textbox(lines=10, label="ä½ è®¾ç½®çš„å‚æ•°ä¼šå†™è¢«åˆ°tomlçš„æœ€ä¸‹é¢ï¼Œå¦‚æœå‡ºç°ä¸é¢„è®¾å‚æ•°é‡åï¼Œç†è®ºä¸Šä½ çš„å‚æ•°ä¼˜å…ˆçº§é«˜ï¼Œä½†å°½é‡åˆ«è¿™ä¹ˆåšï¼Œå¯èƒ½ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„åæœ",\
                                                                            placeholder=f"{self_arguments_placeholder_str}\nmax_grad_norm = 1\noutput_config = true")
                                #æ£€æŸ¥æ ¼å¼
                                def check_self_arguments(self_arguments:str) -> str:
                                    try:
                                        toml.loads(self_arguments)
                                        return "æ ¼å¼æ­£ç¡®"
                                    except Exception as e:
                                        return f"æ ¼å¼é”™è¯¯ error:{e}"
                                chek_self_arguments_botton.click(fn=check_self_arguments,
                                                                inputs=plus_gr_dict["self_arguments"],
                                                                outputs=check_self_arguments_title
                                )
                                
    
        all_gr_dict = {**common_gr_dict, **sample_gr_dict, **plus_gr_dict}
        
        def dict_key_list_2_list(dict_key_list:list, gr_dict:dict):
            """ è¾“å…¥ä¸€ä¸ªæŒ‡å®škeyé¡ºåºçš„å­—ç¬¦ä¸²listï¼Œå’Œä¸€ä¸ªgrç»„ä»¶å˜é‡çš„å­—å…¸"""
            """ å°†gr_dictä¸­é”®åä¸listä¸­å­—ç¬¦ä¸²ç›¸ç­‰çš„å€¼å˜æˆä¸€ä¸ªgrç»„ä»¶åˆ—è¡¨ """
            """ åŒæ—¶è¿”å›parameter_listçš„é•¿åº¦ï¼Œæ–¹ä¾¿ç¡®è®¤å„æ ‡ç­¾é¡µä¸­ç»„ä»¶æ•° """
            list = []
            for key in dict_key_list:
                try:
                    list.append(gr_dict[key])
                except KeyError:
                    print(f"Error: parameter_dict_key_listä¸­{key}ä¸å­˜åœ¨")
            list_len = len(list)
            return list, list_len
    
        """ è·å–ä¸‰ä¸ªå‚æ•°çš„å­—å…¸é”®åæˆä¸ºä¸€ä¸ªlist """
        common_parameter_dict_key_list = list( common_gr_dict.keys() )    
        common_parameter_list, parameter_len_dict["common"] = dict_key_list_2_list(common_parameter_dict_key_list, common_gr_dict)
        
        sample_parameter_dict_key_list = list( sample_gr_dict.keys() ) 
        sample_parameter_list, parameter_len_dict["sample"] = dict_key_list_2_list(sample_parameter_dict_key_list, sample_gr_dict)
    
        plus_parameter_dict_key_list = list( plus_gr_dict.keys() ) 
        plus_parameter_list, parameter_len_dict["plus"] = dict_key_list_2_list(plus_parameter_dict_key_list, plus_gr_dict)
    
        all_parameter_list = common_parameter_list + sample_parameter_list + plus_parameter_list
        all_parameter_dict_key_list = common_parameter_dict_key_list + sample_parameter_dict_key_list + plus_parameter_dict_key_list
        

    
        """ æŒ‰é’®éƒ¨åˆ† """
        #åœ¨æŒ‡å®šè·¯å¾„ä¿å­˜webuiç»„ä»¶configæ–‡ä»¶
        save_webui_config_button.click(fn=save_webui_config,
                        inputs=[save_webui_config_dir, save_webui_config_name, write_files_dir],
                        outputs=save_read_webui_config_title      
        )
        #è·å–æŒ‡å®šè·¯å¾„ä¸‹çš„æ‰€æœ‰ä»¥.tomlæ‰©å±•åçš„æ–‡ä»¶åˆ—è¡¨
        read_webui_config_get_button.click(fn=read_webui_config_get,
                          inputs=[read_webui_config_dir],
                          outputs=[read_webui_config_name]       
        )
        #è¯»å–æŒ‡å®šè·¯å¾„webuiç»„ä»¶configæ–‡ä»¶
        read_webui_config_button.click(fn=read_webui_config,
                        inputs=[read_webui_config_dir, read_webui_config_name, write_files_dir] + all_parameter_list,
                        outputs=[save_read_webui_config_title, write_files_dir] + all_parameter_list
        )
        #åœ¨æŒ‡å®šè·¯å¾„ä¸‹å†™å…¥kohya_toml
        write_files_button.click(fn=write_files,
                    inputs=[write_files_dir],
                    outputs=[write_files_title]
        )
        #ç¡®å®šå¸¸è§„å‚æ•°
        common_parameter_get_button.click(fn=common_parameter_get,
                        inputs=common_parameter_list,
                        outputs=[common_parameter_toml,  common_parameter_title]
        )
        #ç¡®å®šé‡‡æ ·å‚æ•°
        sample_parameter_get_button.click(fn=sample_parameter_get,
                        inputs=sample_parameter_list,
                        outputs=[sample_parameter_toml,  sample_parameter_title]
        )
        #ç¡®å®šè¿›é˜¶å‚æ•°
        plus_parameter_get_button.click(fn=plus_parameter_get,
                        inputs=plus_parameter_list,
                        outputs=[plus_parameter_toml,  plus_parameter_title]
        )
        #ç¡®å®šå…¨éƒ¨å‚æ•°
        all_parameter_get_button.click(fn=all_parameter_get,
                        inputs=all_parameter_list,
                        outputs=[common_parameter_toml, sample_parameter_toml, plus_parameter_toml,  write_files_title]
        )
        #è¯»å–è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
        base_model_get_button.click(fn=model_get,
                      inputs=all_gr_dict["base_model_dir"],
                      outputs=all_gr_dict["base_model_name"]
        )
        #è¯»å–è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
        vae_model_get_button.click(fn=model_get,
                      inputs=all_gr_dict["vae_model_dir"],
                      outputs=all_gr_dict["vae_model_name"]
        )
        return demo


if __name__ == "__main__":
    demo = create_demo()
    demo.launch(share=False,inbrowser=True,inline=True,debug=True)
